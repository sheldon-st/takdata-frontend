# Production deployment — uses pre-built images from GitHub Container Registry.
# External networks (caddy, takdata) must be created before running — see DEPLOY.md.
# Run: docker compose pull && docker compose up -d

services:
  backend:
    image: ghcr.io/sheldon-st/takdata:latest
    restart: unless-stopped
    volumes:
      - tak-data:/app/data
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATA_DIR=/app/data
      - CORS_ORIGINS=${CORS_ORIGINS:-["https://data.opengeo.space"]}
    networks:
      - caddy
      - takdata
    labels:
      caddy: ${API_DOMAIN:-api.data.opengeo.space}
      caddy.reverse_proxy: "{{upstreams 8000}}"

  frontend:
    image: ghcr.io/sheldon-st/takdata-frontend:latest
    restart: unless-stopped
    networks:
      - caddy
    labels:
      caddy: ${DOMAIN:-data.opengeo.space}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      - backend

volumes:
  tak-data:

networks:
  # Both networks must be created externally before running:
  #   docker network create caddy
  #   docker network create takdata
  caddy:
    external: true
  takdata:
    external: true
